#!/usr/bin/env bash
#
# gt-bmad-phase - BMAD phase orchestration for Gas Town
#
# Coordinates handoffs between BMAD phases and agents:
# - Phase 1: Analysis (Analyst) ‚Üí Product Brief
# - Phase 2: Planning (PM, UX Designer) ‚Üí PRD, UX Design
# - Phase 3: Solutioning (Architect, PM) ‚Üí Architecture, Epics/Stories
# - Phase 4: Implementation (Dev, SM) ‚Üí Code, Reviews
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GT_BMAD_ROOT="${GT_BMAD_ROOT:-$(cd "$SCRIPT_DIR/.." && pwd)}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

error() { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
info() { echo -e "${BLUE}info:${NC} $1"; }
success() { echo -e "${GREEN}‚úì${NC} $1"; }
warn() { echo -e "${YELLOW}warning:${NC} $1"; }

# Phase definitions
# Format: phase_id|name|primary_agent|secondary_agents|workflows|artifacts
declare -A PHASES
PHASES["1"]="analysis|Analysis|analyst||research,create-product-brief|product-brief.md"
PHASES["2"]="planning|Planning|pm|ux-designer|prd,create-ux-design|prd.md,ux-design.md"
PHASES["3"]="solutioning|Solutioning|architect|pm|create-architecture,create-epics-and-stories|architecture.md,epics/*.md,stories/*.md"
PHASES["4"]="implementation|Implementation|dev|sm,pm|dev-story,code-review,sprint-planning|src/**/*.ts,src/**/*.go"

# Agent to phase mapping
declare -A AGENT_PHASES
AGENT_PHASES["analyst"]="1"
AGENT_PHASES["pm"]="2,3,4"
AGENT_PHASES["ux-designer"]="2"
AGENT_PHASES["architect"]="3"
AGENT_PHASES["dev"]="4"
AGENT_PHASES["sm"]="4"

# Phase dependencies (what must be complete before phase can start)
declare -A PHASE_DEPS
PHASE_DEPS["1"]=""  # Analysis has no dependencies
PHASE_DEPS["2"]="1"  # Planning needs Analysis
PHASE_DEPS["3"]="2"  # Solutioning needs Planning
PHASE_DEPS["4"]="3"  # Implementation needs Solutioning

# Project root detection
find_project_root() {
    local dir="${1:-$(pwd)}"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/_bmad/project-context.md" || -f "$dir/project-context.md" ]]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    # Fall back to current directory
    echo "$(pwd)"
}

# Get artifact path relative to project
get_artifact_path() {
    local artifact="$1"
    local project_root="${2:-$(find_project_root)}"

    # Check common locations
    local paths=(
        "$project_root/docs/$artifact"
        "$project_root/_bmad/docs/$artifact"
        "$project_root/$artifact"
    )

    for path in "${paths[@]}"; do
        if [[ -f "$path" || -d "$(dirname "$path")" ]]; then
            echo "$path"
            return 0
        fi
    done

    # Default to docs location
    echo "$project_root/docs/$artifact"
}

# Check if artifact exists (supports glob patterns)
artifact_exists() {
    local pattern="$1"
    local project_root="${2:-$(find_project_root)}"

    # Handle glob patterns
    if [[ "$pattern" == *"*"* ]]; then
        local expanded
        expanded=$(find "$project_root" -path "*/$pattern" 2>/dev/null | head -1)
        [[ -n "$expanded" ]]
    else
        # Check common locations
        [[ -f "$project_root/docs/$pattern" ]] || \
        [[ -f "$project_root/_bmad/docs/$pattern" ]] || \
        [[ -f "$project_root/$pattern" ]]
    fi
}

# Parse phase info
get_phase_field() {
    local phase="$1"
    local field="$2"
    local info="${PHASES[$phase]:-}"

    case "$field" in
        id) echo "$info" | cut -d'|' -f1 ;;
        name) echo "$info" | cut -d'|' -f2 ;;
        primary_agent) echo "$info" | cut -d'|' -f3 ;;
        secondary_agents) echo "$info" | cut -d'|' -f4 ;;
        workflows) echo "$info" | cut -d'|' -f5 ;;
        artifacts) echo "$info" | cut -d'|' -f6 ;;
    esac
}

usage() {
    cat <<EOF
gt-bmad-phase - BMAD phase orchestration for Gas Town

Usage: gt-bmad-phase <command> [options]

Phase Information:
  list                    List all BMAD phases with agents and artifacts
  status                  Show current project phase status
  show <phase>            Show details about a specific phase

Phase Gates:
  check <phase>           Check if phase prerequisites are satisfied
  gates <phase>           Show gate requirements for entering a phase
  verify                  Verify all phase artifacts and dependencies

Phase Transitions:
  start <phase>           Start a phase (spawns primary agent)
  advance                 Advance to next phase if gates met
  handoff <phase>         Create handoff context for phase transition

Agent Coordination:
  agents <phase>          List agents that work in a phase
  spawn <phase> [agent]   Spawn an agent for a phase (default: primary)

Examples:
  gt-bmad-phase list                    # Overview of all phases
  gt-bmad-phase status                  # Where is this project?
  gt-bmad-phase check 2                 # Can we start Planning?
  gt-bmad-phase start 2                 # Start Planning phase
  gt-bmad-phase handoff 3               # Prepare handoff to Solutioning

BMAD Phases:
  1. Analysis     - Research and product brief (Analyst)
  2. Planning     - PRD and UX design (PM, UX Designer)
  3. Solutioning  - Architecture and stories (Architect, PM)
  4. Implementation - Code and reviews (Dev, SM)
EOF
}

# List all phases
cmd_list() {
    echo -e "${CYAN}üìã BMAD Project Phases${NC}"
    echo ""
    printf "  %-8s %-15s %-20s %-30s %s\n" "PHASE" "NAME" "PRIMARY AGENT" "WORKFLOWS" "ARTIFACTS"
    printf "  %-8s %-15s %-20s %-30s %s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" "‚îÄ‚îÄ‚îÄ‚îÄ" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

    for phase in 1 2 3 4; do
        local name=$(get_phase_field "$phase" "name")
        local primary=$(get_phase_field "$phase" "primary_agent")
        local workflows=$(get_phase_field "$phase" "workflows" | tr ',' ' ')
        local artifacts=$(get_phase_field "$phase" "artifacts" | tr ',' ' ')

        # Truncate if too long
        [[ ${#workflows} -gt 28 ]] && workflows="${workflows:0:25}..."
        [[ ${#artifacts} -gt 25 ]] && artifacts="${artifacts:0:22}..."

        printf "  %-8s %-15s %-20s %-30s %s\n" \
            "$phase" "$name" "$primary" "$workflows" "$artifacts"
    done

    echo ""
    echo "  Use 'gt-bmad-phase show <phase>' for detailed phase information."
}

# Show phase details
cmd_show() {
    local phase="${1:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase show <phase>"
    fi

    # Validate phase
    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase (valid: 1, 2, 3, 4)"
    fi

    local id=$(get_phase_field "$phase" "id")
    local name=$(get_phase_field "$phase" "name")
    local primary=$(get_phase_field "$phase" "primary_agent")
    local secondary=$(get_phase_field "$phase" "secondary_agents")
    local workflows=$(get_phase_field "$phase" "workflows")
    local artifacts=$(get_phase_field "$phase" "artifacts")
    local deps="${PHASE_DEPS[$phase]:-}"

    echo -e "${CYAN}üì¶ Phase $phase: $name${NC}"
    echo ""
    echo "  ID:              $id"
    echo "  Primary Agent:   $primary"
    [[ -n "$secondary" ]] && echo "  Secondary:       ${secondary//,/, }"
    echo ""
    echo "  Workflows:"
    for wf in ${workflows//,/ }; do
        echo "    - $wf"
    done
    echo ""
    echo "  Output Artifacts:"
    for art in ${artifacts//,/ }; do
        echo "    - $art"
    done

    if [[ -n "$deps" ]]; then
        echo ""
        echo "  Prerequisites:"
        for dep in ${deps//,/ }; do
            local dep_name=$(get_phase_field "$dep" "name")
            echo "    - Phase $dep ($dep_name) must be complete"
        done
    fi

    echo ""
    echo "  Commands:"
    echo "    gt-bmad-phase check $phase     # Check prerequisites"
    echo "    gt-bmad-phase start $phase     # Start this phase"
    echo "    gt-bmad-phase spawn $phase     # Spawn primary agent"
}

# Check phase prerequisites
cmd_check() {
    local phase="${1:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase check <phase>"
    fi

    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase"
    fi

    local name=$(get_phase_field "$phase" "name")
    local deps="${PHASE_DEPS[$phase]:-}"
    local project_root=$(find_project_root)

    echo -e "${CYAN}üîç Checking prerequisites for Phase $phase: $name${NC}"
    echo ""

    local all_met=true

    if [[ -z "$deps" ]]; then
        echo -e "  ${GREEN}‚úì${NC} No prerequisites (first phase)"
    else
        for dep in ${deps//,/ }; do
            local dep_name=$(get_phase_field "$dep" "name")
            local dep_artifacts=$(get_phase_field "$dep" "artifacts")

            echo "  Checking Phase $dep ($dep_name) artifacts:"

            for artifact in ${dep_artifacts//,/ }; do
                if artifact_exists "$artifact" "$project_root"; then
                    echo -e "    ${GREEN}‚úì${NC} $artifact"
                else
                    echo -e "    ${RED}‚úó${NC} $artifact (missing)"
                    all_met=false
                fi
            done
        done
    fi

    echo ""

    if $all_met; then
        echo -e "${GREEN}‚úì Phase $phase prerequisites satisfied${NC}"
        echo ""
        echo "Ready to start Phase $phase. Run:"
        echo "  gt-bmad-phase start $phase"
        return 0
    else
        echo -e "${RED}‚úó Phase $phase prerequisites NOT met${NC}"
        echo ""
        echo "Complete the missing artifacts before starting Phase $phase."
        return 1
    fi
}

# Show gate requirements
cmd_gates() {
    local phase="${1:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase gates <phase>"
    fi

    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase"
    fi

    local name=$(get_phase_field "$phase" "name")
    local deps="${PHASE_DEPS[$phase]:-}"

    echo -e "${CYAN}üö™ Gate Requirements for Phase $phase: $name${NC}"
    echo ""

    if [[ -z "$deps" ]]; then
        echo "  No gates - Phase 1 can start immediately."
        return 0
    fi

    echo "  Required before entering Phase $phase:"
    echo ""

    for dep in ${deps//,/ }; do
        local dep_name=$(get_phase_field "$dep" "name")
        local dep_artifacts=$(get_phase_field "$dep" "artifacts")

        echo "  From Phase $dep ($dep_name):"
        for artifact in ${dep_artifacts//,/ }; do
            echo "    - $artifact"
        done
        echo ""
    done

    echo "  Use 'gt-bmad-phase check $phase' to verify these gates."
}

# Show current status
cmd_status() {
    local project_root=$(find_project_root)

    echo -e "${CYAN}üìä BMAD Project Phase Status${NC}"
    echo ""
    echo "  Project root: $project_root"
    echo ""

    local current_phase=0
    local last_complete=0

    for phase in 1 2 3 4; do
        local name=$(get_phase_field "$phase" "name")
        local artifacts=$(get_phase_field "$phase" "artifacts")

        local phase_complete=true
        local phase_started=false

        for artifact in ${artifacts//,/ }; do
            if artifact_exists "$artifact" "$project_root"; then
                phase_started=true
            else
                phase_complete=false
            fi
        done

        local status_icon status_text
        if $phase_complete; then
            status_icon="${GREEN}‚úì${NC}"
            status_text="Complete"
            last_complete=$phase
        elif $phase_started; then
            status_icon="${YELLOW}‚óê${NC}"
            status_text="In Progress"
            [[ $current_phase -eq 0 ]] && current_phase=$phase
        else
            status_icon="${BLUE}‚óã${NC}"
            status_text="Not Started"
            [[ $current_phase -eq 0 ]] && current_phase=$phase
        fi

        printf "  %b Phase %s: %-15s %s\n" "$status_icon" "$phase" "$name" "$status_text"
    done

    echo ""

    if [[ $last_complete -eq 4 ]]; then
        echo -e "  ${GREEN}${BOLD}All phases complete!${NC}"
    elif [[ $current_phase -gt 0 ]]; then
        local current_name=$(get_phase_field "$current_phase" "name")
        echo "  Current phase: $current_phase ($current_name)"
        echo ""
        echo "  Next steps:"
        echo "    gt-bmad-phase show $current_phase   # View phase details"
        echo "    gt-bmad-phase start $current_phase  # Start working"
    fi
}

# Start a phase
cmd_start() {
    local phase="${1:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase start <phase>"
    fi

    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase"
    fi

    local name=$(get_phase_field "$phase" "name")
    local primary=$(get_phase_field "$phase" "primary_agent")

    # Check prerequisites
    if ! cmd_check "$phase" > /dev/null 2>&1; then
        error "Phase $phase prerequisites not met. Run 'gt-bmad-phase check $phase' for details."
    fi

    echo -e "${CYAN}üöÄ Starting Phase $phase: $name${NC}"
    echo ""
    echo "  Primary agent: $primary"
    echo ""

    # Create phase tracking bead
    local phase_bead
    if phase_bead=$(bd create --title "BMAD Phase $phase: $name" --type task --priority 1 2>&1 | grep -oE '[a-z]+-[a-z0-9]+' | head -1); then
        success "Created phase bead: $phase_bead"
    else
        warn "Could not create phase bead (continuing)"
    fi

    # Spawn primary agent
    echo ""
    echo "Spawning primary agent..."

    if [[ -x "$SCRIPT_DIR/gt-bmad-spawn" ]]; then
        "$SCRIPT_DIR/gt-bmad-spawn" "$primary" ${phase_bead:+--bead "$phase_bead"}
    else
        warn "gt-bmad-spawn not found. Spawn agent manually:"
        echo "  gt-bmad spawn $primary"
    fi
}

# Create handoff context
cmd_handoff() {
    local target_phase="${1:-}"

    if [[ -z "$target_phase" ]]; then
        error "Usage: gt-bmad-phase handoff <target-phase>"
    fi

    if [[ -z "${PHASES[$target_phase]:-}" ]]; then
        error "Invalid phase: $target_phase"
    fi

    local source_phase=$((target_phase - 1))
    if [[ $source_phase -lt 1 ]]; then
        error "Phase 1 has no source phase for handoff"
    fi

    local source_name=$(get_phase_field "$source_phase" "name")
    local target_name=$(get_phase_field "$target_phase" "name")
    local source_artifacts=$(get_phase_field "$source_phase" "artifacts")
    local target_agent=$(get_phase_field "$target_phase" "primary_agent")
    local project_root=$(find_project_root)

    echo -e "${CYAN}ü§ù Phase Handoff: $source_name ‚Üí $target_name${NC}"
    echo ""

    # Build handoff context
    local handoff_context=""
    handoff_context+="# Phase Handoff: $source_name ‚Üí $target_name\n\n"
    handoff_context+="## Source Artifacts\n\n"

    for artifact in ${source_artifacts//,/ }; do
        local artifact_path
        if artifact_exists "$artifact" "$project_root"; then
            artifact_path=$(get_artifact_path "$artifact" "$project_root")
            handoff_context+="- ‚úì $artifact ($artifact_path)\n"
        else
            handoff_context+="- ‚úó $artifact (MISSING)\n"
        fi
    done

    handoff_context+="\n## Target Phase\n\n"
    handoff_context+="- Phase: $target_phase ($target_name)\n"
    handoff_context+="- Primary Agent: $target_agent\n"
    handoff_context+="- Workflows: $(get_phase_field "$target_phase" "workflows")\n"
    handoff_context+="- Expected Output: $(get_phase_field "$target_phase" "artifacts")\n"

    # Write handoff file
    local handoff_file="$project_root/.bmad-handoff-phase-$target_phase.md"
    echo -e "$handoff_context" > "$handoff_file"

    success "Handoff context created: $handoff_file"
    echo ""
    echo "To start Phase $target_phase:"
    echo "  1. Review: cat $handoff_file"
    echo "  2. Start:  gt-bmad-phase start $target_phase"
}

# Advance to next phase
cmd_advance() {
    local project_root=$(find_project_root)

    # Find current phase
    local current_phase=0
    for phase in 1 2 3 4; do
        local artifacts=$(get_phase_field "$phase" "artifacts")
        local phase_complete=true

        for artifact in ${artifacts//,/ }; do
            if ! artifact_exists "$artifact" "$project_root"; then
                phase_complete=false
                break
            fi
        done

        if ! $phase_complete; then
            current_phase=$phase
            break
        fi
    done

    if [[ $current_phase -eq 0 ]]; then
        echo -e "${GREEN}‚úì All phases complete!${NC}"
        return 0
    fi

    local current_name=$(get_phase_field "$current_phase" "name")

    # Check if current phase is complete
    local artifacts=$(get_phase_field "$current_phase" "artifacts")
    local phase_complete=true

    for artifact in ${artifacts//,/ }; do
        if ! artifact_exists "$artifact" "$project_root"; then
            phase_complete=false
            break
        fi
    done

    if ! $phase_complete; then
        echo -e "${YELLOW}Phase $current_phase ($current_name) is not complete${NC}"
        echo ""
        echo "Complete remaining artifacts:"
        for artifact in ${artifacts//,/ }; do
            if ! artifact_exists "$artifact" "$project_root"; then
                echo "  - $artifact"
            fi
        done
        return 1
    fi

    # Advance to next phase
    local next_phase=$((current_phase + 1))
    if [[ $next_phase -gt 4 ]]; then
        echo -e "${GREEN}‚úì All phases complete!${NC}"
        return 0
    fi

    local next_name=$(get_phase_field "$next_phase" "name")

    echo -e "${GREEN}‚úì Phase $current_phase ($current_name) complete${NC}"
    echo ""
    echo "Advancing to Phase $next_phase ($next_name)..."
    echo ""

    # Create handoff and start next phase
    cmd_handoff "$next_phase"
    echo ""
    cmd_start "$next_phase"
}

# List agents for a phase
cmd_agents() {
    local phase="${1:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase agents <phase>"
    fi

    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase"
    fi

    local name=$(get_phase_field "$phase" "name")
    local primary=$(get_phase_field "$phase" "primary_agent")
    local secondary=$(get_phase_field "$phase" "secondary_agents")

    echo -e "${CYAN}üë• Agents for Phase $phase: $name${NC}"
    echo ""
    echo "  Primary:   $primary"
    [[ -n "$secondary" ]] && echo "  Secondary: ${secondary//,/, }"
    echo ""
    echo "  Spawn commands:"
    echo "    gt-bmad spawn $primary        # Primary agent"
    for agent in ${secondary//,/ }; do
        echo "    gt-bmad spawn $agent"
    done
}

# Spawn agent for a phase
cmd_spawn() {
    local phase="${1:-}"
    local agent="${2:-}"

    if [[ -z "$phase" ]]; then
        error "Usage: gt-bmad-phase spawn <phase> [agent]"
    fi

    if [[ -z "${PHASES[$phase]:-}" ]]; then
        error "Invalid phase: $phase"
    fi

    # Default to primary agent
    if [[ -z "$agent" ]]; then
        agent=$(get_phase_field "$phase" "primary_agent")
    fi

    local name=$(get_phase_field "$phase" "name")

    echo -e "${CYAN}üöÄ Spawning agent for Phase $phase: $name${NC}"
    echo ""

    if [[ -x "$SCRIPT_DIR/gt-bmad-spawn" ]]; then
        "$SCRIPT_DIR/gt-bmad-spawn" "$agent"
    else
        error "gt-bmad-spawn not found"
    fi
}

# Verify all phases
cmd_verify() {
    local project_root=$(find_project_root)

    echo -e "${CYAN}üîç Verifying BMAD Project Artifacts${NC}"
    echo ""
    echo "  Project root: $project_root"
    echo ""

    local all_good=true

    for phase in 1 2 3 4; do
        local name=$(get_phase_field "$phase" "name")
        local artifacts=$(get_phase_field "$phase" "artifacts")

        echo "  Phase $phase ($name):"

        for artifact in ${artifacts//,/ }; do
            if artifact_exists "$artifact" "$project_root"; then
                echo -e "    ${GREEN}‚úì${NC} $artifact"
            else
                echo -e "    ${RED}‚úó${NC} $artifact"
                all_good=false
            fi
        done
        echo ""
    done

    if $all_good; then
        echo -e "${GREEN}‚úì All artifacts present${NC}"
    else
        echo -e "${YELLOW}! Some artifacts missing${NC}"
    fi
}

# Main dispatch
main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    local cmd="$1"
    shift

    case "$cmd" in
        list)
            cmd_list "$@"
            ;;
        show)
            cmd_show "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        check)
            cmd_check "$@"
            ;;
        gates)
            cmd_gates "$@"
            ;;
        verify)
            cmd_verify "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        advance)
            cmd_advance "$@"
            ;;
        handoff)
            cmd_handoff "$@"
            ;;
        agents)
            cmd_agents "$@"
            ;;
        spawn)
            cmd_spawn "$@"
            ;;
        help|--help|-h)
            usage
            exit 0
            ;;
        *)
            error "Unknown command: $cmd (try 'gt-bmad-phase help')"
            ;;
    esac
}

main "$@"
